---
create_files:
  - owner:                      'root'
    group:                      'root'
    mode:                       '0755'
    state:                      'directory'
    path:                       '/mnt/big_volume'
shell_commands_ignore_result:
  - user:                       'root'
    chdir:                      '/'
    creates:                    '/creates/nothing/always/run'
    command:                    mountpoint /mnt/big_volume
create_files_phase_2:
  - owner:                      'motion'
    group:                      'motion'
    mode:                       '0700'
    state:                      'directory'
    path:                       '/mnt/big_volume/motion'
filesystems:
  - dev:                        '/dev/mapper/big_volume'
    fstype:                     'ext4'
mount:
  - name:                       '/mnt/big_volume'
    fstype:                     'ext4'
    opts:                       'noatime,noauto,nodev,nosuid,noexec'
    src:                        '/dev/mapper/big_volume'
    state:                      'mounted'
install_packages:
  - 'motion'

width:                          960
height:                         720
fps:                            30
threshold_percent:              .05
threshold:                      "{{ ( width * height * threshold_percent / 100 ) | int }}"
post_capture_seconds:           2
post_capture_frames:            "{{ fps * post_capture_seconds }}"
minimum_motion_seconds:         .5
minimum_motion_frames:          "{{ fps * minimum_motion_seconds }}"

lines_in_files:
  # Daemon settings:
  - line:                       'start_motion_daemon=yes'
    regexp:                     '^start_motion_daemon '
    dest:                       '/etc/default/motion'
  - line:                       'target_dir /mnt/big_volume/motion'
    regexp:                     '^target_dir '
    dest:                       '/etc/motion/motion.conf'
  # Debugging:
  - line:                       'text_changes on'
    regexp:                     '^text_changes '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'locate_motion_mode on'
    regexp:                     '^locate_motion_mode '
    dest:                       '/etc/motion/motion.conf'
  # Video parameters:
  - line:                       "width {{ width }}"
    regexp:                     '^width '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'height {{ height }}'
    regexp:                     '^height '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'framerate {{ fps }}'
    regexp:                     '^framerate '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'quality 85'
    regexp:                     '^quality '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'pre_capture 5'
    regexp:                     '^pre_capture '
    dest:                       '/etc/motion/motion.conf'
  - line:                       "post_capture {{ post_capture_frames }}"
    regexp:                     '^post_capture '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'rotate 180'
    regexp:                     '^rotate '
    dest:                       '/etc/motion/motion.conf'
  # Capture parameters:
  - line:                       "threshold {{ threshold }}"
    regexp:                     '^threshold '
    dest:                       '/etc/motion/motion.conf'
  - line:                       "minimum_motion_frames {{ minimum_motion_frames }}"
    regexp:                     '^minimum_motion_frames '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'noise_tune off'
    regexp:                     '^noise_tune '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'noise_level 96'
    regexp:                     '^noise_level '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'despeckle_filter EedDl'
    regexp:                     '^despeckle_filter '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'lightswitch 1'
    regexp:                     '^lightswitch '
    dest:                       '/etc/motion/motion.conf'
pi_lines_in_files:
  - line:                       'start_x=1'
    regexp:                     '^start_x='
    dest:                       '/boot/config.txt'
  - line:                       'gpu_mem=128'
    regexp:                     '^gpu_mem='
    dest:                       '/boot/config.txt'
enable_services:
  - 'motion'
restart_services:
  - 'motion'
