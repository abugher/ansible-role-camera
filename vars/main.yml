---
create_files:
  - owner:                      'root'
    group:                      'root'
    mode:                       '0755'
    state:                      'directory'
    path:                       '/mnt/big_volume'
shell_commands_ignore_result:
  - user:                       'root'
    chdir:                      '/'
    creates:                    '/creates/nothing/always/run'
    command:                    mountpoint /mnt/big_volume
create_files_phase_2:
  - owner:                      'motion'
    group:                      'motion'
    mode:                       '0700'
    state:                      'directory'
    path:                       '/mnt/big_volume/motion'
filesystems:
  - dev:                        '/dev/mapper/big_volume'
    fstype:                     'ext4'
mount:
  - name:                       '/mnt/big_volume'
    fstype:                     'ext4'
    opts:                       'noatime,noauto,nodev,nosuid,noexec'
    src:                        '/dev/mapper/big_volume'
    state:                      'mounted'
install_packages:
  - 'motion'
lines_in_files:
  - line:                       'start_motion_daemon=yes'
    regexp:                     '^start_motion_daemon '
    dest:                       '/etc/default/motion'
  - line:                       'target_dir /mnt/big_volume/motion'
    regexp:                     '^target_dir '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'rotate 180'
    regexp:                     '^rotate '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'width 960'
    regexp:                     '^width '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'height 720'
    regexp:                     '^height '
    dest:                       '/etc/motion/motion.conf'
    # 960 * 720 * 10% = 69120 px
  - line:                       'threshold 69120 '
    regexp:                     '^threshold '
    dest:                       '/etc/motion/motion.conf'
    # 960 x 720 @ 30fps seems like the max for RPi4b with picam 2.1.
  - line:                       'framerate 30'
    regexp:                     '^framerate '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'quality 85'
    regexp:                     '^quality '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'lightswitch 50'
    regexp:                     '^lightswitch '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'minimum_motion_frames 5'
    regexp:                     '^minimum_motion_frames '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'pre_capture 5'
    regexp:                     '^pre_capture '
    dest:                       '/etc/motion/motion.conf'
  - line:                       'post_capture 5'
    regexp:                     '^post_capture '
    dest:                       '/etc/motion/motion.conf'
pi_lines_in_files:
  - line:                       'start_x=1'
    regexp:                     '^start_x='
    dest:                       '/boot/config.txt'
  - line:                       'gpu_mem=128'
    regexp:                     '^gpu_mem='
    dest:                       '/boot/config.txt'
enable_services:
  - 'motion'
restart_services:
  - 'motion'
